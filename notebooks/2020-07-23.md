# 2020-07-23 Progress Report 

## Contents
1. Development of a Dashboard for data wrangling
2. Implementation of online classifications into ROS and existing navigation stack
3. Preliminary testing of online classifications

## Dashboard Development
The Dashboard is a python module that allows for the management, analysis and visualization of data gathered from the Myhal Simulation during SLAM testing.

### Functionality

#### Run Management
The user interacts with a `Dashboard()` object:
```python
# this setup is for jupyter lab and is not nessecary when using IPython directly
%matplotlib notebook
from src.dashboard import *

D = Dashboard() # optionally we can specify the verbosity of the output messages. default is logger.INFO
```

We can list the valid runs present in the experiment folder: ~/raid/Myhal_Simulation/simulated_runs/.
```python       
D.list_runs() # by default, we only list the 10 most recent runs (if there are 10 available)
```

We can obtain information on a specific run by index or date:
```python
D.run_info('2020-07-17-12-47-30')
```

Some directories in the experimental folder to not constitute valid runs (malformed or missing data). We can list all folders and their validity.
```python
D.list_dirs()
```

Any old directories can be deleted (not without first being prompted for confirmation).
```python
D.remove_dir('old_directory')
```

#### Data Visualization and Analysis
In order to visualize data, first the user must specify what data they want to see. This is done by adding `Series()` objects to the `Dashboard()`. Series represent a set of runs adhering to various characteristics. Currently available characteristics include:
- time ranges (earliest date, latest date, exact date)
- index ranges (min index, max index, exact index)
- filtering status
- classification method
- tour name
- success status
- localization method
- scenarios present during the test
- whether or not the run was a *localization test* or not

The user must name the series, and has the option to choose it's colors.
The directories corrisponding to the runs of a given series can also be deleted with `remove_series_dirs()` which allows for a user to clean runs based on a certain charateristic (usually used for removing runs from before a certain date).
```python
# Create a set of series that used E_tour to compare online predictions and ground truth classifications against a control
D.add_series('Online Classification', tour_names = 'E_tour', class_method = 'online_predictions') 
D.add_series('Ground Truth Classification', tour_names = 'E_tour', class_method = 'ground_truth')
D.add_series('No Classification', tour_names = 'E_tour', class_method = 'none')
```
The user must also choose what type of plot(s) that they want to show on the dashboard. Currently available plot types include:
- Translation Error
- Yaw Error 
- Trajectory Plot (a top down view of the robots path)
- Path Difference (the % path length difference between the robots path and the optimal path)
- Success Rate (the % of tours in the given series that succeeded) 

When a given series has many different runs, plotting them all individually can become unintelligible. Thus plots can also aggregate all of the runs for a given series (this feature is not yet available for trajectory plots)

```python
D.resize(1,2) # resize the distpay such that it has one row and two columns
D.add_plot(TranslationError(aggregate = True)
D.add_plot(YawError(aggregate = True)
D.show()
```

We can add more plot types, and the display will automatically re-size to fit them.

```python
D.add_plot(TrajectoryPlot())
D.add_plot(YawError(aggregate = True))
D.show()
```

Textual information about each plot can also be displayed (text information for the trajectory plot is not available):

```python
D.plot_info(TranslationError)
D.plot_info(YawError)
D.plot_info(PathDiff)
```

We note here that plotting the trajectories of multiple runs at once is confusing and not very informative. Thus, we also have the option to plot individual runs for any given plot type.

```python
D.plot_run(3, TrajectoryPlot) # once again we can specify and index or a date
```

Note that the function returns a plot object such that information about it can be printed.

```python
D.plot_run(3, TranslationError)
```

Lets try a run with a more interesting tour:

```python
D.plot_run('2020-07-17-13-39-30', TrajectoryPlot)
```

The dashboard also has the ability to remove and replace plots and series:

```python
D.clear_series()
D.remove_plot(TrajectoryPlot)
D.add_series('amcl', localization_technique = 'amcl')
D.add_series('gmapping', localization_technique = 'gmapping')
D.show()
```

The dashboard can allow for more insight on a particular run through the `visualize_run()` function. This will play the bag file of the run along with a pre-configured RVIZ file such that you can [watch the run](https://drive.google.com/file/d/1mtxeToJq3NKKFZOPiAdD8kIhR018uM79/view?usp=sharing).

```python
D.visualize_run(0, rate = 1.5) # this will play back the run at 1.5x speed (see video)
```

## Online Classifications 
Online classifications have been implemented in ROS Noetic and integrated into the existing navigation stack. 

#### Implementation
The *Online Classifier Node* subscribes to the unclassified point-clouds (an Nx3 array) generated from the VLP-32 LIDAR simulator (from within the Myhal Gazebo simulation). This returns a subset of the original points (an Mx3 array with M<=M) and an array of corresponding point classifications (of length M). 

These data are fed through a function which converts the single 3D point-clouds into multiple 2D laser-scans. Each laser-scan corresponds to a different set of points. For example when using AMCL for localization, three laser-scan messages are produced per point-cloud, each including a subset of the original points based on their class:
- only including long term moveables (to AMCL)
- including all static objects (to global planner)
- including all objects (to local planner)
as shown in Figure 1.

#### Preliminary Testing 
While the network is not fully trained, and the code has yet to be optimized for this application, we have gathered some preliminary test results.
